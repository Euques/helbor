<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Expositores</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Estilos personalizados para as imagens de prévia */
      .img-preview {
        max-width: 100%;
        max-height: 250px;
        object-fit: contain;
        display: block;
        margin: 20px auto;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* Spinner centralizado no meio da página */
      .spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner-container .spinner-border {
        color: #007bff;
      }

      /* Área de mensagens de status */
      #status {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        text-align: center;
        padding: 10px;
        font-size: 1.2rem;
      }

      /* Melhorando o layout do formulário */
      .form-group {
        position: relative;
      }

      /* Deixando o formulário mais espaçado */
      .form-control, .form-label {
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Carregando Spinner -->
    <div class="spinner-container" id="loadingSpinner">
      <div class="spinner-border" role="status"></div>
    </div>

    <!-- Status de mensagens -->
    <div id="status"></div>

    <div class="container mt-5">
      <h2 class="text-center">Cadastro de Expositor</h2>
      <form id="expositorForm" class="mt-4">
        <div class="mb-3">
          <label for="name" class="form-label">Nome</label>
          <input
            type="text"
            class="form-control"
            id="name"
            placeholder="Digite o nome"
            required
          />
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Descrição</label>
          <textarea
            class="form-control"
            id="description"
            rows="3"
            placeholder="Digite a descrição"
            required
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="category" class="form-label">Categoria</label>
          <input
            type="text"
            class="form-control"
            id="category"
            placeholder="Digite a categoria"
            required
          />
        </div>

        <!-- Logotipo -->
        <div class="mb-3">
          <label for="logo" class="form-label">Logotipo</label>
          <input type="file" class="form-control" id="logo" accept="image/*" />
          <div class="mt-2">
            <img
              id="logoPreview"
              class="img-preview"
              src="#"
              alt="Prévia do logotipo"
              style="display: none"
            />
          </div>
        </div>

        <!-- Imagem do Produto -->
        <div class="mb-3">
          <label for="image" class="form-label">Imagem do Produto</label>
          <input type="file" class="form-control" id="image" accept="image/*" />
          <div class="mt-2">
            <img
              id="imagePreview"
              class="img-preview"
              src="#"
              alt="Prévia da imagem"
              style="display: none"
            />
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Salvar</button>
        <button
          id="deleteButton"
          type="button"
          class="btn btn-danger w-100 mt-2"
        >
          Deletar
        </button>
      </form>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
      } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject,
      } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js';

      // Configuração Firebase
      const firebaseConfig = {
        apiKey: 'AIzaSyB8-03eq_8LCMfcxuY-Z4eCVWV32Ad4lfQ',
        authDomain: 'feira-265d4.firebaseapp.com',
        databaseURL: 'https://feira-265d4-default-rtdb.firebaseio.com',
        projectId: 'feira-265d4',
        storageBucket: 'feira-265d4.firebasestorage.app',
        messagingSenderId: '124883888377',
        appId: '1:124883888377:web:c4e8c834b313127f6a5a28',
        measurementId: 'G-2QFQD5NGXR'
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const params = new URLSearchParams(window.location.search);
      const uid = params.get('u');
      const statusDiv = document.getElementById('status');

      if (!uid) {
        statusDiv.innerHTML =
          '<div class="alert alert-danger">Erro: UID não encontrado na URL.</div>';
        throw new Error('UID não encontrado na URL.');
      }

      // Carregar expositor
      async function loadExpositor() {
        try {
          const docRef = doc(db, 'users', uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('name').value = data.name || '';
            document.getElementById('description').value = data.description || '';
            document.getElementById('category').value = data.category || '';
          } else {
            statusDiv.innerHTML =
              '<div class="alert alert-warning">Expositor não encontrado.</div>';
          }
        } catch (error) {
          console.error('Erro ao carregar expositor:', error);
          statusDiv.innerHTML =
            '<div class="alert alert-danger">Erro ao carregar dados.</div>';
        }
      }

      // Salvar expositor
      async function saveExpositor(uid, name, description, category, logoFile, imageFile) {
        showLoading(true); // Exibe o carregando
        try {
          const updates = { name, description, category, updatedAt: new Date() };

          if (logoFile) {
            const logoRef = ref(storage, `users/${uid}/logo.jpg`);
            const logoSnapshot = await uploadBytes(logoRef, logoFile);
            updates.logoURL = await getDownloadURL(logoSnapshot.ref);
          }
          if (imageFile) {
            const imageRef = ref(storage, `users/${uid}/image.jpg`);
            const imageSnapshot = await uploadBytes(imageRef, imageFile);
            updates.imageURL = await getDownloadURL(imageSnapshot.ref);
          }

          await setDoc(doc(db, 'users', uid), updates, { merge: true });
          statusDiv.innerHTML =
            '<div class="alert alert-success">Dados salvos com sucesso!</div>';
        } catch (error) {
          console.error('Erro ao salvar expositor:', error);
          statusDiv.innerHTML =
            '<div class="alert alert-danger">Erro ao salvar dados.</div>';
        } finally {
          showLoading(false); // Oculta o carregando
        }
      }

      // Deletar expositor
      async function deleteExpositor(uid) {
        showLoading(true); // Exibe o carregando
        try {
          await deleteDoc(doc(db, 'users', uid));

          const logoRef = ref(storage, `users/${uid}/logo.jpg`);
          const imageRef = ref(storage, `users/${uid}/image.jpg`);
          await deleteObject(logoRef).catch(() => {});
          await deleteObject(imageRef).catch(() => {});

          statusDiv.innerHTML =
            '<div class="alert alert-danger">Expositor deletado com sucesso.</div>';
        } catch (error) {
          console.error('Erro ao deletar expositor:', error);
          statusDiv.innerHTML =
            '<div class="alert alert-danger">Erro ao deletar expositor.</div>';
        } finally {
          showLoading(false); // Oculta o carregando
        }
      }

      // Mostrar o carregando
      function showLoading(isLoading) {
        document.getElementById('loadingSpinner').style.display = isLoading ? 'flex' : 'none';
      }

      // Mostrar prévia da imagem
      function showPreview(input, previewId, spinnerId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        const spinner = document.getElementById(spinnerId);
        if (file) {
          preview.style.display = 'none';
          spinner.style.display = 'block';
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.style.display = 'block';
            preview.src = e.target.result;
            spinner.style.display = 'none'; // Oculta o carregando
          };
          reader.readAsDataURL(file);
        }
      }

      // Inicializar a página
      document.addEventListener('DOMContentLoaded', () => {
        loadExpositor();
        const logoInput = document.getElementById('logo');
        const imageInput = document.getElementById('image');

        logoInput.addEventListener('change', () => {
          showPreview(logoInput, 'logoPreview', 'logoSpinner');
        });
        imageInput.addEventListener('change', () => {
          showPreview(imageInput, 'imagePreview', 'imageSpinner');
        });

        // Botão de salvar
        document.getElementById('expositorForm').addEventListener('submit', (event) => {
          event.preventDefault();
          const name = document.getElementById('name').value;
          const description = document.getElementById('description').value;
          const category = document.getElementById('category').value;
          const logoFile = logoInput.files[0];
          const imageFile = imageInput.files[0];

          saveExpositor(uid, name, description, category, logoFile, imageFile);
        });

        // Botão de deletar
        document.getElementById('deleteButton').addEventListener('click', () => {
          deleteExpositor(uid);
        });
      });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
