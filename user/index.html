<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Expositores</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .hidden-preview {
        display: none;
        max-height: 150px;
        margin-top: 10px;
      }
      .btn-discreet {
        background-color: transparent;
        border: none;
        color: #007bff;
        cursor: pointer;
        text-decoration: underline;
      }
      .btn-discreet:hover {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="text-center">Cadastro de Expositor</h2>
      <form id="expositorForm" class="mt-4">
        <div class="mb-3">
          <label for="name" class="form-label">Nome</label>
          <input
            type="text"
            class="form-control"
            id="name"
            placeholder="Digite o nome"
            required
          />
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Descrição</label>
          <textarea
            class="form-control"
            id="description"
            rows="3"
            placeholder="Digite a descrição"
            required
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="category" class="form-label">Categoria</label>
          <input
            type="text"
            class="form-control"
            id="category"
            placeholder="Digite a categoria"
            required
          />
        </div>
        <div class="mb-3">
          <label for="logo" class="form-label">Logotipo</label>
          <input type="file" class="form-control" id="logo" accept="image/*" />
          <img
            id="logoPreview"
            src="#"
            alt="Prévia do logotipo"
            class="hidden-preview img-thumbnail"
          />
          <button
            type="button"
            id="clearLogo"
            class="btn-discreet"
            style="display: none;"
          >
            Remover logotipo
          </button>
        </div>
        <div class="mb-3">
          <label for="image" class="form-label">Imagem</label>
          <input type="file" class="form-control" id="image" accept="image/*" />
          <img
            id="imagePreview"
            src="#"
            alt="Prévia da imagem"
            class="hidden-preview img-thumbnail"
          />
          <button
            type="button"
            id="clearImage"
            class="btn-discreet"
            style="display: none;"
          >
            Remover imagem
          </button>
        </div>
        <button type="submit" class="btn btn-primary w-100">Salvar</button>
        <button id="deleteButton" type="button" class="btn btn-danger w-100 mt-2">
          Deletar
        </button>
      </form>
      <div id="status" class="mt-3"></div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        deleteDoc
      } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
      } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyB8-03eq_8LCMfcxuY-Z4eCVWV32Ad4lfQ',
        authDomain: 'feira-265d4.firebaseapp.com',
        projectId: 'feira-265d4',
        storageBucket: 'feira-265d4.appspot.com',
        messagingSenderId: '124883888377',
        appId: '1:124883888377:web:c4e8c834b313127f6a5a28'
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const params = new URLSearchParams(window.location.search);
      const uid = params.get('u');
      const statusDiv = document.getElementById('status');

      if (!uid) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Erro: UID não encontrado na URL.</div>';
        throw new Error('UID não encontrado na URL.');
      }

      // Prévia de imagem
      function showPreview(input, previewId, clearButtonId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        const clearButton = document.getElementById(clearButtonId);
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
          clearButton.style.display = 'inline';
        }
      }

      document.getElementById('logo').addEventListener('change', (e) => {
        showPreview(e.target, 'logoPreview', 'clearLogo');
      });

      document.getElementById('image').addEventListener('change', (e) => {
        showPreview(e.target, 'imagePreview', 'clearImage');
      });

      document.getElementById('clearLogo').addEventListener('click', () => {
        document.getElementById('logo').value = '';
        document.getElementById('logoPreview').style.display = 'none';
        document.getElementById('clearLogo').style.display = 'none';
      });

      document.getElementById('clearImage').addEventListener('click', () => {
        document.getElementById('image').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('clearImage').style.display = 'none';
      });

      document.getElementById('deleteButton').addEventListener('click', async () => {
        if (confirm('Tem certeza que deseja deletar este expositor?')) {
          try {
            await deleteDoc(doc(db, 'users', uid));
            await deleteObject(ref(storage, `users/${uid}/logo.jpg`)).catch(() => {});
            await deleteObject(ref(storage, `users/${uid}/image.jpg`)).catch(() => {});
            statusDiv.innerHTML = '<div class="alert alert-success">Expositor deletado com sucesso!</div>';
          } catch (error) {
            statusDiv.innerHTML = '<div class="alert alert-danger">Erro ao deletar expositor.</div>';
          }
        }
      });

      // Outros métodos permanecem os mesmos
      // Carregar expositor, salvar expositor...
    </script>
  </body>
</html>
