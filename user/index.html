<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Expositores</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .preview-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
      }
      .spinner {
        display: none;
        width: 24px;
        height: 24px;
        border: 4px solid rgba(0, 0, 0, 0.3);
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="my-4">Cadastro de Expositores</h1>
      <form id="expositorForm">
        <div class="mb-3">
          <label for="name" class="form-label">Nome do Expositor</label>
          <input
            type="text"
            class="form-control"
            id="name"
            placeholder="Nome do Expositor"
          />
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Descrição</label>
          <textarea
            class="form-control"
            id="description"
            rows="3"
            placeholder="Descrição do Expositor"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="category" class="form-label">Categoria</label>
          <input
            type="text"
            class="form-control"
            id="category"
            placeholder="Categoria"
          />
        </div>
        <div class="mb-3">
          <label for="logo" class="form-label">Logo</label>
          <input
            type="file"
            class="form-control"
            id="logo"
            accept="image/*"
          />
          <div class="spinner" id="logoSpinner"></div>
          <img id="logoPreview" class="preview-img" style="display: none" />
        </div>
        <div class="mb-3">
          <label for="image" class="form-label">Imagem</label>
          <input
            type="file"
            class="form-control"
            id="image"
            accept="image/*"
          />
          <div class="spinner" id="imageSpinner"></div>
          <img id="imagePreview" class="preview-img" style="display: none" />
        </div>
        <div id="statusDiv"></div>
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-danger" id="deleteButton">Deletar</button>
      </form>

      <hr />

      <h2>Pré-visualização das Imagens Armazenadas:</h2>
      <div id="imagePreviewsContainer">
        <!-- As prévias das imagens carregadas do Firebase Storage vão aparecer aqui -->
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage.js"></script>
    <script>
      // Configuração do Firebase com suas credenciais
      const firebaseConfig = {
        apiKey: 'YOUR_API_KEY',  // Substitua por sua chave API
        authDomain: 'YOUR_PROJECT_ID.firebaseapp.com',  // Substitua pelo seu ID do projeto
        projectId: 'YOUR_PROJECT_ID',  // Substitua pelo seu ID do projeto
        storageBucket: 'YOUR_PROJECT_ID.appspot.com',  // Substitua pelo seu bucket do Firebase
        messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',  // Substitua pelo seu ID de remetente
        appId: 'YOUR_APP_ID',  // Substitua pelo seu ID de app
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Função para carregar expositor
      async function loadExpositor() {
        const expositorId = 'EXPOSITOR_UID'; // Substitua pelo UID do expositor
        const expositorDoc = await getDoc(doc(db, 'users', expositorId));

        if (expositorDoc.exists()) {
          const expositorData = expositorDoc.data();

          // Preencher os campos do formulário
          document.getElementById('name').value = expositorData.name || '';
          document.getElementById('description').value = expositorData.description || '';
          document.getElementById('category').value = expositorData.category || '';

          // Carregar prévia da logo
          if (expositorData.logoURL) {
            const logoPreview = document.getElementById('logoPreview');
            logoPreview.style.display = 'block';
            logoPreview.src = expositorData.logoURL;
          }

          // Carregar prévia da imagem
          if (expositorData.imageURL) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.style.display = 'block';
            imagePreview.src = expositorData.imageURL;
          }
        } else {
          console.error('Expositor não encontrado');
        }
      }

      // Função para salvar expositor
      async function saveExpositor(uid, name, description, category, logoFile, imageFile) {
        showLoading(true);
        try {
          // Atualizar os dados do expositor no Firestore
          const docRef = doc(db, 'users', uid);
          await setDoc(docRef, {
            name,
            description,
            category,
          });

          // Salvar logo no Firebase Storage
          let logoURL = '';
          if (logoFile) {
            const logoRef = ref(storage, `logos/${uid}`);
            await uploadBytes(logoRef, logoFile);
            logoURL = await getDownloadURL(logoRef);
            await setDoc(docRef, { logoURL }, { merge: true });
          }

          // Salvar imagem no Firebase Storage
          let imageURL = '';
          if (imageFile) {
            const imageRef = ref(storage, `images/${uid}`);
            await uploadBytes(imageRef, imageFile);
            imageURL = await getDownloadURL(imageRef);
            await setDoc(docRef, { imageURL }, { merge: true });
          }

          document.getElementById('statusDiv').innerHTML =
            '<div class="alert alert-success">Expositor salvo com sucesso!</div>';
        } catch (error) {
          console.error('Erro ao salvar expositor:', error);
          document.getElementById('statusDiv').innerHTML =
            '<div class="alert alert-danger">Erro ao salvar expositor.</div>';
        } finally {
          showLoading(false);
        }
      }

      // Função para deletar expositor
      async function deleteExpositor(uid) {
        showLoading(true);
        try {
          const docRef = doc(db, 'users', uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            // Excluir imagens do Firebase Storage
            if (data.logoURL) {
              const logoRef = ref(storage, data.logoURL);
              await deleteObject(logoRef);
            }
            if (data.imageURL) {
              const imageRef = ref(storage, data.imageURL);
              await deleteObject(imageRef);
            }

            // Excluir dados do Firestore
            await deleteDoc(docRef);
            document.getElementById('statusDiv').innerHTML =
              '<div class="alert alert-success">Expositor deletado com sucesso.</div>';
          } else {
            document.getElementById('statusDiv').innerHTML =
              '<div class="alert alert-danger">Erro: Expositor não encontrado.</div>';
          }
        } catch (error) {
          console.error('Erro ao deletar expositor:', error);
          document.getElementById('statusDiv').innerHTML =
            '<div class="alert alert-danger">Erro ao deletar expositor.</div>';
        } finally {
          showLoading(false);
        }
      }

      // Função para mostrar o carregamento
      function showLoading(isLoading) {
        document.getElementById('loadingSpinner').style.display = isLoading ? 'flex' : 'none';
      }

      // Inicializar a página
      document.addEventListener('DOMContentLoaded', () => {
        loadExpositor();
      });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
